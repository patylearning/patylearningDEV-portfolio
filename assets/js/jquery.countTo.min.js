(function($) {
  // Format number with decimals
  function formatNumber(number, settings) {
      return number.toFixed(settings.decimals);
  }

  $.fn.countTo = function(options) {
      options = options || {};

      return $(this).each(function() {
          // Get settings
          var settings = $.extend({}, $.fn.countTo.defaults, {
              from: $(this).data('from'),
              to: $(this).data('to'),
              speed: $(this).data('speed'),
              refreshInterval: $(this).data('refresh-interval'),
              decimals: $(this).data('decimals')
          }, options);

          // Initialize variables
          var loops = Math.ceil(settings.speed / settings.refreshInterval),
              increment = (settings.to - settings.from) / loops,
              self = this,
              $self = $(this),
              loopCount = 0,
              value = settings.from,
              data = $self.data('countTo') || {};

          // Store countTo data
          $self.data('countTo', data);

          // Clear previous interval
          if (data.interval) {
              clearInterval(data.interval);
          }

          // Start counting
          data.interval = setInterval(updateTimer, settings.refreshInterval);
          render(value);

          function updateTimer() {
              value += increment;
              loopCount++;
              render(value);

              if (typeof(settings.onUpdate) == 'function') {
                  settings.onUpdate.call(self, value);
              }

              if (loopCount >= loops) {
                  $self.removeData('countTo');
                  clearInterval(data.interval);
                  value = settings.to;

                  if (typeof(settings.onComplete) == 'function') {
                      settings.onComplete.call(self, value);
                  }
              }
          }

          function render(value) {
              var formattedValue = settings.formatter.call(self, value, settings);
              $self.text(formattedValue);
          }
      });
  };

  // Default settings
  $.fn.countTo.defaults = {
      from: 0,
      to: 0,
      speed: 1000,
      refreshInterval: 100,
      decimals: 0,
      formatter: formatNumber,
      onUpdate: null,
      onComplete: null
  };

})(jQuery);